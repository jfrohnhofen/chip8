Applied some optimizations from Polymorph.